# Implementation Plan

- [x] 1. Install MCP SDK and dependencies
  - Install @modelcontextprotocol/sdk, zod, swagger-parser packages
  - Update package.json in services/api
  - Run npm install
  - _Requirements: All_

- [x] 2. Create database schema for MCP configurations
  - [x] 2.1 Create migration file for mcp_configs table
    - Add mcp_configs table with mode, API docs, server URLs, credentials fields
    - Add unique constraint on user_id
    - _Requirements: 1.1, 1.5, 2.4, 3.2_
  
  - [x] 2.2 Create migration file for mcp_tools table
    - Add mcp_tools table with tool definitions, schemas, roles
    - Add foreign key to mcp_configs
    - _Requirements: 2.2, 3.3, 4.3_
  
  - [x] 2.3 Create migration file for mcp_tool_invocations table
    - Add logging table for tool invocations
    - Add indexes for performance
    - _Requirements: 6.1_
  
  - [x] 2.4 Update agents table schema
    - Add mcp_tools and mcp_config_id columns
    - Create migration file
    - _Requirements: 4.3_
  
  - [x] 2.5 Run database migrations
    - Execute all migration files
    - Verify schema changes
    - _Requirements: All_

- [x] 3. Implement MCP Client wrapper
  - [x] 3.1 Create MCPClient class
    - Implement connect, disconnect, listTools, callTool methods
    - Handle connection errors and retries
    - _Requirements: 3.2, 3.3, 5.1_
  
  - [x] 3.2 Write property test for MCP client connection
    - **Property 3: BYO-MCP Connection Validation**
    - **Validates: Requirements 3.2**
  
  - [x] 3.3 Write unit tests for MCPClient
    - Test tool listing, tool invocation, error handling
    - Mock MCP server responses
    - _Requirements: 3.3, 5.1_

- [x] 4. Implement MCP Manager Service
  - [x] 4.1 Create MCPManagerService class
    - Implement createAutoGeneratedMCP, createBYOMCP methods
    - Implement getMCPConfig, switchMCPMode methods
    - Implement discoverTools, invokeTool, validateConnection methods
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.2, 3.3, 5.1_
  
  - [x] 4.2 Implement credential encryption/decryption
    - Use existing encryption utilities
    - Encrypt credentials before storing
    - Decrypt when connecting to MCP servers
    - _Requirements: 7.1_
  
  - [x] 4.3 Write property test for credential encryption
    - **Property 6: Credential Encryption Round-Trip**
    - **Validates: Requirements 7.1**
  
  - [x] 4.4 Write property test for mode switching
    - **Property 4: Agent Tool Access Restriction**
    - **Validates: Requirements 1.4, 4.3**
  
  - [x] 4.5 Write unit tests for MCP Manager
    - Test MCP config creation, tool discovery, connection validation
    - _Requirements: 1.1, 1.2, 1.3, 3.2, 3.3_

- [x] 5. Implement Analyzer Agent Service
  - [x] 5.1 Create AnalyzerAgentService class
    - Implement analyzeOpenAPI, analyzeGraphQL, analyzeRESTDocs methods
    - Implement generateMCPTools, categorizeToolsByRole methods
    - Use LLM (GPT-4 or Claude) for API analysis
    - _Requirements: 2.1, 2.2, 2.3_
  
  - [x] 5.2 Create OpenAPI parser integration
    - Use swagger-parser to parse OpenAPI specs
    - Extract endpoints, parameters, responses
    - _Requirements: 2.1_
  
  - [x] 5.3 Implement MCP tool generation logic
    - Convert API endpoints to MCP tool definitions
    - Generate JSON schemas for inputs/outputs
    - Categorize tools by role (Dev, QA, Product, etc.)
    - _Requirements: 2.2, 2.3_
  
  - [x] 5.4 Write property test for tool generation
    - **Property 2: Analyzer Agent Tool Generation Completeness**
    - **Validates: Requirements 2.2**
  
  - [x] 5.5 Write unit tests for Analyzer Agent
    - Test API parsing, tool generation, role categorization
    - Mock LLM responses
    - _Requirements: 2.1, 2.2, 2.3_

- [x] 6. Create MCP API routes
  - [x] 6.1 Create POST /api/mcp/auto-generated endpoint
    - Accept API documentation
    - Trigger analyzer agent
    - Return generated MCP configuration
    - _Requirements: 1.2, 2.1, 2.2_
  
  - [x] 6.2 Create POST /api/mcp/bring-your-own endpoint
    - Accept MCP server URL and credentials
    - Validate connection
    - Discover and store tools
    - _Requirements: 1.3, 3.2, 3.3_
  
  - [x] 6.3 Create GET /api/mcp/config endpoint
    - Return user's current MCP configuration
    - Include mode and available tools
    - _Requirements: 1.5_
  
  - [x] 6.4 Create PUT /api/mcp/mode endpoint
    - Switch between auto-generated and BYO modes
    - Preserve existing agents
    - _Requirements: 1.4_
  
  - [x] 6.5 Create GET /api/mcp/tools endpoint
    - Return available MCP tools
    - Filter by role if specified
    - _Requirements: 4.1_
  
  - [x] 6.6 Write integration tests for MCP routes
    - Test all endpoints with valid and invalid inputs
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.2, 3.3_

- [-] 7. Update Agent Service for MCP integration
  - [x] 7.1 Update createAgent to accept MCP tools
    - Add mcpTools parameter
    - Validate tools against available MCP tools
    - Store tool access in database
    - _Requirements: 4.1, 4.2, 4.3_
  
  - [x] 7.2 Update agent execution to use MCP tools
    - Modify orchestrator to invoke MCP tools
    - Pass tool results back to agent LLM
    - Handle tool invocation errors
    - _Requirements: 5.1, 5.2, 5.3, 5.4_
  
  - [x] 7.3 Implement tool invocation logging
    - Log all MCP tool calls to mcp_tool_invocations table
    - Include parameters, results, duration, errors
    - _Requirements: 6.1, 6.2_
  
  - [ ] 7.4 Write property test for tool access control
    - **Property 4: Agent Tool Access Restriction**
    - **Validates: Requirements 4.3**
  
  - [ ] 7.5 Write property test for tool invocation logging
    - **Property 5: MCP Tool Invocation Logging**
    - **Validates: Requirements 6.1**
  
  - [ ] 7.6 Write unit tests for agent MCP integration
    - Test agent creation with tools, tool invocation, logging
    - _Requirements: 4.1, 4.3, 5.1, 6.1_

- [ ] 8. Create frontend UI for MCP configuration
  - [ ] 8.1 Create MCP setup page component
    - Add mode selection (auto-generated vs BYO)
    - Show current MCP status
    - _Requirements: 1.1, 1.5_
  
  - [ ] 8.2 Create auto-generated MCP form
    - File upload for API documentation
    - Text area for pasting API specs
    - Trigger analyzer agent button
    - Show analysis progress and results
    - _Requirements: 1.2, 2.1_
  
  - [ ] 8.3 Create BYO-MCP configuration form
    - Input for MCP server URL
    - Auth type selection (none, bearer, api-key)
    - Credential inputs
    - Test connection button
    - Show discovered tools
    - _Requirements: 1.3, 3.2, 3.3_
  
  - [ ] 8.4 Update agent creation form
    - Add MCP tools selection
    - Show available tools filtered by role
    - Allow multi-select with checkboxes
    - Show tool descriptions
    - _Requirements: 4.1, 4.2_
  
  - [ ] 8.5 Create MCP tools management page
    - List all available MCP tools
    - Show tool details (name, description, schema)
    - Filter by role/category
    - _Requirements: 4.1_
  
  - [ ] 8.6 Add MCP tool invocation display in execution history
    - Show which tools were called
    - Display parameters and results
    - Highlight errors
    - _Requirements: 6.1, 6.2_

- [ ] 9. Update workspace chat for MCP tool usage
  - [ ] 9.1 Display MCP tool invocations in chat
    - Show when agents call tools
    - Display tool names and parameters
    - Show results inline
    - _Requirements: 6.1_
  
  - [ ] 9.2 Add tool usage indicators
    - Show which agent is using which tool
    - Display tool execution status (pending, success, error)
    - _Requirements: 6.1_

- [ ] 10. Implement MCP analytics and monitoring
  - [ ] 10.1 Create analytics queries
    - Most used tools
    - Tool success/failure rates
    - Average tool execution time
    - Tools per agent
    - _Requirements: 6.3_
  
  - [ ] 10.2 Add analytics dashboard page
    - Display MCP usage statistics
    - Show tool performance metrics
    - Visualize tool usage over time
    - _Requirements: 6.3_

- [ ] 11. Add security and rate limiting
  - [ ] 11.1 Implement rate limiting for MCP tool invocations
    - Per-user limits
    - Per-agent limits
    - Configurable by subscription tier
    - _Requirements: 7.5_
  
  - [ ] 11.2 Add input validation for tool parameters
    - Validate against JSON schemas
    - Sanitize inputs
    - Prevent injection attacks
    - _Requirements: 5.1, 5.4_
  
  - [ ] 11.3 Implement secure protocol validation
    - Ensure HTTPS/WSS for all MCP connections
    - Reject insecure protocols
    - _Requirements: 7.4_
  
  - [ ] 11.4 Write property test for secure protocols
    - **Property: Secure Protocol Enforcement**
    - **Validates: Requirements 7.4**

- [ ] 12. Documentation and examples
  - [ ] 12.1 Update README with MCP features
    - Explain two MCP modes
    - Provide setup instructions
    - _Requirements: All_
  
  - [ ] 12.2 Create MCP integration guide
    - Step-by-step setup for both modes
    - Example API documentation
    - Example MCP server configuration
    - _Requirements: 1.1, 1.2, 1.3_
  
  - [ ] 12.3 Update Integration page with MCP examples
    - Add MCP tool invocation examples
    - Show how to use agents with MCP
    - _Requirements: 5.1_

- [ ] 13. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
